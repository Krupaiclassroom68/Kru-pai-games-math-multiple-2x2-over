<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>2-digit √ó 2-digit ¬∑ Double Carry ¬∑ Blue Theme</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #ffffff;
      color: #1a237e;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
      padding: 16px;
    }
    .app {
      width: 100%;
      max-width: 900px;
      margin: 0 auto;
      border-radius: 16px;
      padding: 24px 20px 28px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.06);
      border: 1px solid #e3f2fd;
      background: #ffffff;
    }
    h1 {
      margin: 0 0 4px;
      font-size: 1.8rem;
      color: #1e88e5;
      text-align: center;
      letter-spacing: 0.04em;
    }
    .subtitle {
      text-align: center;
      font-size: 0.95rem;
      color: #455a64;
      margin-bottom: 18px;
    }
    .kp-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid #bbdefb;
      background: #e3f2fd;
      color: #1565c0;
      font-size: 0.8rem;
      margin-bottom: 16px;
    }
    .kp-badge span.logo {
      font-weight: 700;
      border-radius: 4px;
      padding: 2px 6px;
      background: #ffffff;
      border: 1px solid #bbdefb;
    }
    .hidden { display: none; }

    /* player bar */
    .player-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.9rem;
      color: #455a64;
      margin-bottom: 12px;
      gap: 8px;
      flex-wrap: wrap;
    }
    .player-name-label {
      font-weight: 600;
      color: #1565c0;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 8px 16px;
      font-size: 0.95rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.15s ease;
    }
    .btn-primary {
      background: #1e88e5;
      color: #fff;
    }
    .btn-primary:hover { background: #1976d2; }
    .btn-outline {
      background: #ffffff;
      color: #1e88e5;
      border: 1px solid #bbdefb;
    }
    .btn-outline:hover { background: #e3f2fd; }
    .btn-ghost {
      border-radius: 999px;
      border: 1px solid #cfd8dc;
      background: transparent;
      padding: 6px 12px;
      font-size: 0.9rem;
      cursor: pointer;
      color: #546e7a;
      transition: all 0.15s ease;
    }
    .btn-ghost:hover { background: #eceff1; }

    .small-note {
      font-size: 0.8rem;
      color: #607d8b;
      margin-top: 10px;
      text-align: center;
    }

    /* name view */
    #nameView h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 10px;
      color: #1e88e5;
    }
    .name-form {
      max-width: 360px;
      margin: 0 auto 8px;
      text-align: center;
    }
    .name-form label {
      display: block;
      font-size: 0.95rem;
      margin-bottom: 6px;
    }
    .name-form input {
      width: 100%;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid #cfd8dc;
      font-size: 1rem;
      text-align: center;
      margin-bottom: 12px;
      outline: none;
    }
    .name-form input:focus {
      border-color: #1e88e5;
      box-shadow: 0 0 0 2px rgba(30,136,229,0.18);
    }

    /* set overview */
    #setSelectView h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 8px;
      color: #1e88e5;
    }
    .progress-box {
      margin-bottom: 12px;
      padding: 10px 12px;
      border-radius: 12px;
      background: #f5f5f5;
      border: 1px dashed #90caf9;
      font-size: 0.9rem;
      color: #455a64;
    }
    .set-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px,1fr));
      gap: 10px;
    }
    .set-card {
      border-radius: 14px;
      padding: 10px 10px;
      border: 1px solid #bbdefb;
      background: #e8f4ff;
      cursor: pointer;
      transition: all 0.15s ease;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .set-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(25,118,210,0.18);
      border-color: #64b5f6;
    }
    .set-title {
      font-weight: 700;
      color: #1565c0;
      font-size: 1rem;
    }
    .set-detail {
      font-size: 0.85rem;
      color: #455a64;
    }
    .set-status {
      font-size: 0.85rem;
      font-weight: 600;
    }
    .set-status.success { color: #2e7d32; }
    .set-status.in-progress { color: #f57c00; }
    .set-status.not-started { color: #757575; }

    /* set detail */
    #setDetailView h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 6px;
      color: #1e88e5;
    }
    .back-row {
      display: flex;
      justify-content: flex-start;
      margin-bottom: 10px;
    }
    #currentSetLabel {
      text-align: center;
      font-size: 0.9rem;
      color: #455a64;
      margin-bottom: 8px;
    }
    .page-score-row {
      display: flex;
      justify-content: center;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 10px;
    }
    .page-score-box {
      min-width: 70px;
      padding: 4px 6px;
      border-radius: 999px;
      border: 1px solid #bbdefb;
      background: #e3f2fd;
      font-size: 0.8rem;
      text-align: center;
      color: #1565c0;
    }
    .page-score-box.active {
      background: #1e88e5;
      color: #fff;
      border-color: #1e88e5;
      font-weight: 700;
    }
    .page-score-box.fullscore {
      background: #e8f5e9;
      color: #1b5e20;
      border-color: #66bb6a;
    }
    .page-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(130px,1fr));
      gap: 10px;
      margin-top: 6px;
    }
    .page-card {
      border-radius: 12px;
      border: 1px solid #bbdefb;
      background: #ffffff;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .page-name {
      font-weight: 600;
      font-size: 0.95rem;
      color: #1565c0;
    }
    .page-info-text {
      font-size: 0.85rem;
      color: #455a64;
    }
    .page-btn {
      margin-top: 4px;
      align-self: flex-start;
      padding: 4px 10px;
      font-size: 0.85rem;
    }

    /* game view */
    #gameView h2 {
      text-align: center;
      margin-top: 0;
      margin-bottom: 4px;
      color: #1e88e5;
    }
    #currentGameLabel {
      text-align: center;
      font-size: 0.9rem;
      color: #455a64;
      margin-bottom: 8px;
    }
    .question-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(230px,1fr));
      gap: 14px;
      margin-bottom: 16px;
    }
    .question-card {
      border-radius: 12px;
      border: 1px solid #e0e0e0;
      background: #fafafa;
      padding: 10px 8px 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      overflow: hidden;
    }
    .q-number {
      position: absolute;
      top: 6px;
      left: 8px;
      font-size: 0.8rem;
      color: #78909c;
      font-weight: 600;
    }

    /* layout: 1 row = sign + 4 digit columns (th, h, t, o) */
    .mult-layout {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }
    .mult-row {
      display: grid;
      grid-template-columns: 28px repeat(4, 36px);
      column-gap: 6px;
      align-items: center;
      justify-content: center;
    }
    .carry-row { margin-bottom: 0; }

    .digit-box {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      border: 1px solid #cfd8dc;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 600;
      background: #ffffff;
      color: #263238;
    }
    .digit-box.blank { visibility: hidden; }

    .answer-input {
      width: 36px;
      height: 36px;
      border-radius: 6px;
      border: 1px solid #cfd8dc;
      text-align: center;
      font-size: 1.2rem;
      font-weight: 600;
      outline: none;
      color: #263238;
      background: #ffffff;
    }
    .answer-input:focus {
      border-color: #1e88e5;
      box-shadow: 0 0 0 2px rgba(30,136,229,0.18);
    }

    .carry-input {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px solid #ffeb3b;
      background: #fffde7;
      color: #f9a825;
      font-size: 1rem;
      text-align: center;
      font-weight: 600;
      outline: none;
    }
    .carry-input.crossed {
      text-decoration: line-through;
      color: #b0bec5;
      border-color: #cfd8dc;
      background: #eceff1;
    }
    .carry-spacer {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      background: transparent;
    }

    .sign-box {
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      font-weight: 700;
      color: #1e88e5;
    }

    .hline-full {
      width: 220px;
      border-bottom: 2px solid #cfd8dc;
      margin: 4px 0;
    }

    .result-icon {
      margin-top: 4px;
      font-size: 1.1rem;
      min-height: 1.2em;
    }
    .result-icon.correct { color: #2e7d32; }
    .result-icon.wrong { color: #c62828; }

    .controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 8px;
    }

    .score-row {
      text-align: center;
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: #263238;
    }
    .message {
      text-align: center;
      font-size: 0.9rem;
      min-height: 1.2em;
    }
    .message.success { color: #2e7d32; }
    .message.error { color: #c62828; }

    .footer-note {
      margin-top: 8px;
      font-size: 0.78rem;
      text-align: center;
      color: #78909c;
    }

    /* confetti */
    .confetti-piece {
      position: absolute;
      font-size: 1rem;
      animation: confetti-fall 700ms ease-out forwards;
      pointer-events: none;
    }
    @keyframes confetti-fall {
      0% { transform: translateY(0) rotate(0deg); opacity: 1; }
      100% { transform: translateY(25px) rotate(360deg); opacity: 0; }
    }

    @media (max-width: 600px) {
      .app { padding: 18px 14px 22px; }
      h1 { font-size: 1.4rem; }
      .mult-layout { transform: scale(0.92); }
    }
  </style>
</head>
<body>
  <div class="app">
    <h1>2-digit √ó 2-digit</h1>
    <div class="subtitle">
      Vertical multiplication with double carry ¬∑ Blue Theme ¬∑ Kru Pai Classroom
    </div>
    <div class="kp-badge">
      <span class="logo">KP</span> Times Practice ¬∑ Double Carry
    </div>

    <div class="player-bar hidden" id="playerBar">
      <div>Player: <span class="player-name-label" id="playerNameDisplay">-</span></div>
      <button class="btn-ghost" id="changeNameBtn">Change name</button>
    </div>

    <!-- name view -->
    <div id="nameView">
      <h2>Enter your nickname</h2>
      <div class="name-form">
        <label for="playerNameInput">Nickname</label>
        <input id="playerNameInput" type="text" placeholder="e.g. Ploy, Boss, Mint" />
        <button class="btn-primary" id="startWithNameBtn">Start</button>
      </div>
      <div class="small-note">
        Your nickname will appear on the checklist and score screens üòä
      </div>
    </div>

    <!-- set overview -->
    <div id="setSelectView" class="hidden">
      <h2>Set Checklist</h2>
      <div class="progress-box" id="overallSummary">
        See how many sets you have finished ‚ú®
      </div>
      <div class="set-grid" id="setGrid"></div>
      <div class="small-note">
        Each set has 20 questions (5 pages √ó 4 questions). Try to get ‚ÄúSuccess!‚Äù in all 6 sets üí™
      </div>
    </div>

    <!-- set detail -->
    <div id="setDetailView" class="hidden">
      <div class="back-row">
        <button class="btn-ghost" id="backToOverviewBtn">&larr; Back to all sets</button>
      </div>
      <h2 id="setTitle">Set 1</h2>
      <div id="currentSetLabel"></div>
      <div class="page-score-row" id="detailScoreRow"></div>
      <div class="progress-box" id="setMessageBox"></div>
      <div class="page-grid" id="pageGrid"></div>
    </div>

    <!-- game view -->
    <div id="gameView" class="hidden">
      <div class="back-row">
        <button class="btn-ghost" id="backToSetBtn">&larr; Back to set checklist</button>
      </div>
      <h2 id="gameTitle">Set 1 ¬∑ Page 1</h2>
      <div id="currentGameLabel"></div>
      <div class="page-score-row" id="gameScoreRow"></div>

      <div class="question-grid" id="questionGrid"></div>

      <div class="controls">
        <button class="btn-primary" id="checkBtn">Check answers</button>
        <button class="btn-outline" id="clearBtn">Clear this page</button>
        <button class="btn-outline" id="nextPageBtn">Next page ‚ûú</button>
      </div>

      <div class="score-row" id="scoreRow">Score: ‚Äì / 4</div>
      <div class="message" id="messageBox"></div>

      <div class="footer-note">
        Fill carries (optional), partial products, and final answer ¬∑ 4 questions per page
      </div>
    </div>
  </div>

  <script>
    // ===== SAFE STORAGE =====
    let safeStorage = {
      getItem: () => null,
      setItem: () => {},
      removeItem: () => {}
    };
    (function initStorage() {
      try {
        if (typeof window !== "undefined" && window.localStorage) {
          safeStorage = window.localStorage;
        }
      } catch (e) {
        safeStorage = {
          getItem: () => null,
          setItem: () => {},
          removeItem: () => {}
        };
      }
    })();

    // ===== CONFIG =====
    const SET_COUNT = 6;
    const PAGES_PER_SET = 5;
    const QUESTIONS_PER_PAGE = 4;

    const PLAYER_NAME_KEY = "kp_2x2_blue_carry_player_v3_align";
    const SCORE_PREFIX   = "kp_2x2_blue_carry_score_v3_align_";

    // ===== DOM =====
    const playerBar = document.getElementById("playerBar");
    const playerNameDisplay = document.getElementById("playerNameDisplay");
    const changeNameBtn = document.getElementById("changeNameBtn");

    const nameView = document.getElementById("nameView");
    const setSelectView = document.getElementById("setSelectView");
    const setDetailView = document.getElementById("setDetailView");
    const gameView = document.getElementById("gameView");

    const playerNameInput = document.getElementById("playerNameInput");
    const startWithNameBtn = document.getElementById("startWithNameBtn");

    const overallSummary = document.getElementById("overallSummary");
    const setGrid = document.getElementById("setGrid");

    const backToOverviewBtn = document.getElementById("backToOverviewBtn");
    const setTitle = document.getElementById("setTitle");
    const currentSetLabel = document.getElementById("currentSetLabel");
    const detailScoreRow = document.getElementById("detailScoreRow");
    const setMessageBox = document.getElementById("setMessageBox");
    const pageGrid = document.getElementById("pageGrid");

    const backToSetBtn = document.getElementById("backToSetBtn");
    const gameTitle = document.getElementById("gameTitle");
    const currentGameLabel = document.getElementById("currentGameLabel");
    const gameScoreRow = document.getElementById("gameScoreRow");
    const questionGrid = document.getElementById("questionGrid");
    const checkBtn = document.getElementById("checkBtn");
    const clearBtn = document.getElementById("clearBtn");
    const nextPageBtn = document.getElementById("nextPageBtn");
    const scoreRow = document.getElementById("scoreRow");
    const messageBox = document.getElementById("messageBox");

    // ===== STATE =====
    let currentSetIndex = null;
    let currentPageIndex = null;

    const ALL_SETS = generateAllSets();

    // ===== STORAGE HELPERS =====
    function loadPlayerName() {
      try {
        const name = safeStorage.getItem(PLAYER_NAME_KEY);
        return name && name.trim ? name.trim() : null;
      } catch (e) {
        return null;
      }
    }
    function savePlayerName(name) {
      try {
        safeStorage.setItem(PLAYER_NAME_KEY, name);
      } catch (e) {}
      playerNameDisplay.textContent = name;
    }
    function scoreKey(setIndex, pageIndex) {
      return SCORE_PREFIX + setIndex + "_" + pageIndex;
    }
    function getPageScore(setIndex, pageIndex) {
      try {
        const val = safeStorage.getItem(scoreKey(setIndex, pageIndex));
        return val ? Number(val) : 0;
      } catch (e) {
        return 0;
      }
    }
    function setPageScore(setIndex, pageIndex, score) {
      try {
        const key = scoreKey(setIndex, pageIndex);
        const current = getPageScore(setIndex, pageIndex);
        if (score > current) {
          safeStorage.setItem(key, String(score));
        }
      } catch (e) {}
    }
    function getSetTotalScore(setIndex) {
      let total = 0;
      for (let p = 0; p < PAGES_PER_SET; p++) {
        total += getPageScore(setIndex, p);
      }
      return total;
    }
    function getCompletedPagesCount(setIndex) {
      let count = 0;
      for (let p = 0; p < PAGES_PER_SET; p++) {
        if (getPageScore(setIndex, p) === QUESTIONS_PER_PAGE) count++;
      }
      return count;
    }

    // ===== MATH HELPERS =====
    function computeCarriesForRow(m, digit) {
      const A = Math.floor(m / 10);
      const B = m % 10;
      const step1 = B * digit;
      const carryB = Math.floor(step1 / 10);
      const step2 = A * digit + carryB;
      const carryA = Math.floor(step2 / 10);
      return [carryA, carryB]; // [carry above tens, carry above ones] ‚Äì ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏±‡∏ß‡πÅ‡∏£‡∏Å
    }
    function digits3(num) {
      const h = Math.floor(num / 100);
      const t = Math.floor((num % 100) / 10);
      const o = num % 10;
      return [h, t, o];
    }
    function digits4(num) {
      const th = Math.floor(num / 1000);
      const h = Math.floor((num % 1000) / 100);
      const t = Math.floor((num % 100) / 10);
      const o = num % 10;
      return [th, h, t, o];
    }
    function computeRow1Digits(m, n) {
      const D = n % 10;
      const p1 = m * D;
      return digits3(p1);
    }
    function computeRow2DigitsShifted(m, n) {
      const C = Math.floor(n / 10);
      const p2shifted = m * C * 10; // ‡∏Ñ‡∏π‡∏ì‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏•‡∏∑‡πà‡∏≠‡∏ô‡∏´‡∏ô‡∏∂‡πà‡∏á‡∏´‡∏•‡∏±‡∏Å
      const th = Math.floor(p2shifted / 1000);
      const h = Math.floor((p2shifted % 1000) / 100);
      const t = Math.floor((p2shifted % 100) / 10);
      return [th, h, t]; // (th, h, t) ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö (‡∏û‡∏±‡∏ô, ‡∏£‡πâ‡∏≠‡∏¢, ‡∏™‡∏¥‡∏ö) ‚Äì ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô 0
    }

    // ===== QUESTION GENERATION =====
    function generateSingleQuestion2x2WithCarry() {
      while (true) {
        const m = Math.floor(Math.random() * 80) + 20; // 20‚Äì99
        const n = Math.floor(Math.random() * 80) + 20; // 20‚Äì99

        const D = n % 10;
        const C = Math.floor(n / 10);

        const [c1A, c1B] = computeCarriesForRow(m, D);
        const [c2A, c2B] = computeCarriesForRow(m, C);

        if (c1A || c1B || c2A || c2B) {
          return { m, n };
        }
      }
    }

    function generateAllSets() {
      const sets = [];
      for (let s = 0; s < SET_COUNT; s++) {
        const arr = [];
        const used = new Set();
        while (arr.length < PAGES_PER_SET * QUESTIONS_PER_PAGE) {
          const q = generateSingleQuestion2x2WithCarry();
          const key = q.m + "x" + q.n;
          if (used.has(key)) continue;
          used.add(key);
          arr.push(q);
        }
        sets.push(arr);
      }
      return sets;
    }

    // ===== VIEW SWITCHING =====
    function showNameView() {
      nameView.classList.remove("hidden");
      setSelectView.classList.add("hidden");
      setDetailView.classList.add("hidden");
      gameView.classList.add("hidden");
      playerBar.classList.add("hidden");
      playerNameInput.focus();
    }
    function showSetOverview() {
      nameView.classList.add("hidden");
      setDetailView.classList.add("hidden");
      gameView.classList.add("hidden");
      setSelectView.classList.remove("hidden");
      playerBar.classList.remove("hidden");
      buildSetOverview();
    }
    function showSetDetail(setIndex) {
      currentSetIndex = setIndex;
      currentPageIndex = null;

      setSelectView.classList.add("hidden");
      gameView.classList.add("hidden");
      setDetailView.classList.remove("hidden");

      const setNo = setIndex + 1;
      const playerName = loadPlayerName() || "-";
      const totalScore = getSetTotalScore(setIndex);
      const completedPages = getCompletedPagesCount(setIndex);

      setTitle.textContent = "Set " + setNo;
      currentSetLabel.textContent =
        "Player: " + playerName + " ¬∑ Total score for this set: " + totalScore + " / 20";

      renderPageScoreRow(detailScoreRow, setIndex, null);

      if (completedPages === PAGES_PER_SET &&
          totalScore === PAGES_PER_SET * QUESTIONS_PER_PAGE) {
        setMessageBox.textContent =
          "Success! Full score on all 5 pages in Set " + setNo + " üéâ";
      } else if (completedPages > 0) {
        setMessageBox.textContent =
          "Full score on " + completedPages + " / " + PAGES_PER_SET +
          " pages. Keep going ‚ú®";
      } else {
        setMessageBox.textContent =
          "Set " + setNo + " not started yet. Try Page 1 first üòä";
      }

      buildPageGrid(setIndex);
    }
    function showGamePage(setIndex, pageIndex) {
      currentSetIndex = setIndex;
      currentPageIndex = pageIndex;

      setDetailView.classList.add("hidden");
      gameView.classList.remove("hidden");

      const setNo = setIndex + 1;
      const pageNo = pageIndex + 1;
      const playerName = loadPlayerName() || "-";

      gameTitle.textContent = "Set " + setNo + " ¬∑ Page " + pageNo;
      currentGameLabel.textContent =
        "Player: " + playerName + " ¬∑ 2-digit √ó 2-digit (with double carry)";

      renderPageScoreRow(gameScoreRow, setIndex, pageIndex);
      renderQuestionsForPage(setIndex, pageIndex);
      clearFeedbackOnly();
    }

    // ===== RENDER HELPERS =====
    function buildSetOverview() {
      setGrid.innerHTML = "";
      let playedSets = 0;
      let successSets = 0;

      for (let s = 0; s < SET_COUNT; s++) {
        const total = getSetTotalScore(s);
        const completed = getCompletedPagesCount(s);

        if (total > 0) playedSets++;
        if (completed === PAGES_PER_SET &&
            total === PAGES_PER_SET * QUESTIONS_PER_PAGE) {
          successSets++;
        }

        const card = document.createElement("div");
        card.className = "set-card";

        const title = document.createElement("div");
        title.className = "set-title";
        title.textContent = "Set " + (s + 1);

        const detail = document.createElement("div");
        detail.className = "set-detail";
        detail.textContent =
          "Pages full score: " + completed + " / " + PAGES_PER_SET +
          " ¬∑ Total: " + total + " / 20";

        const status = document.createElement("div");
        status.className = "set-status";

        if (completed === PAGES_PER_SET &&
            total === PAGES_PER_SET * QUESTIONS_PER_PAGE) {
          status.textContent = "‚úÖ Success!";
          status.classList.add("success");
        } else if (total > 0) {
          status.textContent = "‚≠ê In progress";
          status.classList.add("in-progress");
        } else {
          status.textContent = "Not started";
          status.classList.add("not-started");
        }

        card.appendChild(title);
        card.appendChild(detail);
        card.appendChild(status);

        card.addEventListener("click", () => showSetDetail(s));

        setGrid.appendChild(card);
      }

      const name = loadPlayerName() || "-";
      if (playedSets === 0) {
        overallSummary.textContent =
          "Player: " + name + " ¬∑ No sets played yet. Start with Set 1 ‚ú®";
      } else {
        overallSummary.textContent =
          "Player: " + name +
          " ¬∑ Played " + playedSets + " / " + SET_COUNT +
          " sets ¬∑ Success in " + successSets + " sets üéâ";
      }
    }

    function renderPageScoreRow(container, setIndex, activePageIndex) {
      container.innerHTML = "";
      for (let p = 0; p < PAGES_PER_SET; p++) {
        const box = document.createElement("div");
        const score = getPageScore(setIndex, p);
        box.className = "page-score-box";
        if (p === activePageIndex) box.classList.add("active");
        if (score === QUESTIONS_PER_PAGE) box.classList.add("fullscore");
        box.textContent = "P" + (p + 1) + ": " + score + "/4";
        container.appendChild(box);
      }
    }

    function buildPageGrid(setIndex) {
      pageGrid.innerHTML = "";
      for (let p = 0; p < PAGES_PER_SET; p++) {
        const card = document.createElement("div");
        card.className = "page-card";

        const pageName = document.createElement("div");
        pageName.className = "page-name";
        pageName.textContent = "Page " + (p + 1);

        const score = getPageScore(setIndex, p);
        const info = document.createElement("div");
        info.className = "page-info-text";
        info.textContent = "Best score: " + score + " / 4";

        const btn = document.createElement("button");
        btn.className = "btn-outline page-btn";
        btn.textContent = score === 4 ? "Replay" : "Play";
        btn.addEventListener("click", () => showGamePage(setIndex, p));

        card.appendChild(pageName);
        card.appendChild(info);
        card.appendChild(btn);

        pageGrid.appendChild(card);
      }
    }

    function makeDigitBox(d, blank = false) {
      const box = document.createElement("div");
      box.className = "digit-box" + (blank ? " blank" : "");
      box.textContent = blank ? "" : (d === 0 ? "" : d);
      return box;
    }
    function makeAnsInput(correct) {
      const inp = document.createElement("input");
      inp.type = "number";
      inp.inputMode = "numeric";
      inp.className = "answer-input";
      inp.dataset.correct = correct;
      return inp;
    }
    function makeBlankBox() {
      return makeDigitBox(0, true);
    }
    function makeCarryInput(correct, layer) {
      const inp = document.createElement("input");
      inp.type = "number";
      inp.inputMode = "numeric";
      inp.className = "carry-input";
      inp.dataset.correct = correct;
      inp.dataset.layer = layer;
      return inp;
    }
    function makeCarryBlank() {
      const d = document.createElement("div");
      d.className = "carry-spacer";
      return d;
    }
    function makeSignBox(ch) {
      const d = document.createElement("div");
      d.className = "sign-box";
      d.textContent = ch || "";
      return d;
    }

    function renderQuestionsForPage(setIndex, pageIndex) {
      questionGrid.innerHTML = "";

      const all = ALL_SETS[setIndex];
      const start = pageIndex * QUESTIONS_PER_PAGE;
      const end = start + QUESTIONS_PER_PAGE;

      for (let idx = start; idx < end; idx++) {
        const q = all[idx];
        const card = document.createElement("div");
        card.className = "question-card";

        const qNumber = document.createElement("div");
        qNumber.className = "q-number";
        qNumber.textContent = "No. " + (idx + 1);
        card.appendChild(qNumber);

        const layout = document.createElement("div");
        layout.className = "mult-layout";

        const A = Math.floor(q.m / 10);
        const B = q.m % 10;
        const C = Math.floor(q.n / 10);
        const D = q.n % 10;

        const [c1A] = computeCarriesForRow(q.m, D);
        const [c2A] = computeCarriesForRow(q.m, C);
        const row1Digits = computeRow1Digits(q.m, q.n);       // [h, t, o]
        const row2Digits = computeRow2DigitsShifted(q.m, q.n); // [th, h, t]
        const finalDigits = digits4(q.m * q.n);                // [th, h, t, o]

        // Carry row 1 ‚Äì ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö (‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà 4)
        let row = document.createElement("div");
        row.className = "mult-row carry-row";
        row.appendChild(makeSignBox(""));
        row.appendChild(makeCarryBlank()); // ‡∏û‡∏±‡∏ô
        row.appendChild(makeCarryBlank()); // ‡∏£‡πâ‡∏≠‡∏¢
        row.appendChild(makeCarryInput(c1A, "carry1")); // ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö
        row.appendChild(makeCarryBlank()); // ‡∏´‡∏ô‡πà‡∏ß‡∏¢
        layout.appendChild(row);

        // Carry row 2 ‚Äì ‡πÄ‡∏´‡∏ô‡∏∑‡∏≠‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö (‡∏≠‡∏µ‡∏Å‡∏ä‡∏±‡πâ‡∏ô)
        row = document.createElement("div");
        row.className = "mult-row carry-row";
        row.appendChild(makeSignBox(""));
        row.appendChild(makeCarryBlank());
        row.appendChild(makeCarryBlank());
        row.appendChild(makeCarryInput(c2A, "carry2"));
        row.appendChild(makeCarryBlank());
        layout.appendChild(row);

        // Multiplicand AB ‚Üí ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö‚Äì‡∏´‡∏ô‡πà‡∏ß‡∏¢
        row = document.createElement("div");
        row.className = "mult-row";
        row.appendChild(makeSignBox(""));
        row.appendChild(makeBlankBox());          // ‡∏û‡∏±‡∏ô
        row.appendChild(makeBlankBox());          // ‡∏£‡πâ‡∏≠‡∏¢
        row.appendChild(makeDigitBox(A));         // ‡∏™‡∏¥‡∏ö
        row.appendChild(makeDigitBox(B));         // ‡∏´‡∏ô‡πà‡∏ß‡∏¢
        layout.appendChild(row);

        // Multiplier CD ‚Üí ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏¥‡∏ö‚Äì‡∏´‡∏ô‡πà‡∏ß‡∏¢ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢ √ó ‡∏î‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        row = document.createElement("div");
        row.className = "mult-row";
        row.appendChild(makeSignBox("√ó"));
        row.appendChild(makeBlankBox());
        row.appendChild(makeBlankBox());
        row.appendChild(makeDigitBox(C));
        row.appendChild(makeDigitBox(D));
        layout.appendChild(row);

        // ‡πÄ‡∏™‡πâ‡∏ô‡πÅ‡∏ö‡πà‡∏á
        let line = document.createElement("div");
        line.className = "hline-full";
        layout.appendChild(line);

        // Partial product row 1 (3 ‡∏Å‡∏•‡πà‡∏≠‡∏á) ‚Üí ‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤: ‡∏£‡πâ‡∏≠‡∏¢‚Äì‡∏™‡∏¥‡∏ö‚Äì‡∏´‡∏ô‡πà‡∏ß‡∏¢
        row = document.createElement("div");
        row.className = "mult-row";
        row.appendChild(makeSignBox(""));          // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏´‡∏°‡∏≤‡∏¢
        row.appendChild(makeBlankBox());           // ‡∏û‡∏±‡∏ô‡∏ß‡πà‡∏≤‡∏á
        row.appendChild(makeAnsInput(row1Digits[0])); // ‡∏£‡πâ‡∏≠‡∏¢
        row.appendChild(makeAnsInput(row1Digits[1])); // ‡∏™‡∏¥‡∏ö
        row.appendChild(makeAnsInput(row1Digits[2])); // ‡∏´‡∏ô‡πà‡∏ß‡∏¢
        layout.appendChild(row);

        // Partial product row 2 (3 ‡∏Å‡∏•‡πà‡∏≠‡∏á) ‚Üí ‡∏û‡∏±‡∏ô‚Äì‡∏£‡πâ‡∏≠‡∏¢‚Äì‡∏™‡∏¥‡∏ö (‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô 0)
        row = document.createElement("div");
        row.className = "mult-row";
        row.appendChild(makeSignBox("+"));
        row.appendChild(makeAnsInput(row2Digits[0])); // ‡∏û‡∏±‡∏ô
        row.appendChild(makeAnsInput(row2Digits[1])); // ‡∏£‡πâ‡∏≠‡∏¢
        row.appendChild(makeAnsInput(row2Digits[2])); // ‡∏™‡∏¥‡∏ö
        row.appendChild(makeBlankBox());              // ‡∏´‡∏ô‡πà‡∏ß‡∏¢‡πÄ‡∏õ‡πá‡∏ô 0 ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô
        layout.appendChild(row);

        // ‡πÄ‡∏™‡πâ‡∏ô‡∏£‡∏ß‡∏°
        line = document.createElement("div");
        line.className = "hline-full";
        layout.appendChild(line);

        // Final result (4 ‡∏Å‡∏•‡πà‡∏≠‡∏á) ‚Üí ‡∏û‡∏±‡∏ô‚Äì‡∏£‡πâ‡∏≠‡∏¢‚Äì‡∏™‡∏¥‡∏ö‚Äì‡∏´‡∏ô‡πà‡∏ß‡∏¢
        row = document.createElement("div");
        row.className = "mult-row";
        row.appendChild(makeSignBox(""));
        row.appendChild(makeAnsInput(finalDigits[0])); // ‡∏û‡∏±‡∏ô
        row.appendChild(makeAnsInput(finalDigits[1])); // ‡∏£‡πâ‡∏≠‡∏¢
        row.appendChild(makeAnsInput(finalDigits[2])); // ‡∏™‡∏¥‡∏ö
        row.appendChild(makeAnsInput(finalDigits[3])); // ‡∏´‡∏ô‡πà‡∏ß‡∏¢
        layout.appendChild(row);

        card.appendChild(layout);

        const icon = document.createElement("div");
        icon.className = "result-icon";
        card.appendChild(icon);

        questionGrid.appendChild(card);
      }
    }

    // ===== CONFETTI =====
    function launchConfettiAt(card) {
      const count = 10;
      for (let i = 0; i < count; i++) {
        const span = document.createElement("span");
        span.className = "confetti-piece";
        span.textContent = Math.random() < 0.5 ? "üéâ" : "‚ú®";
        span.style.left = (20 + Math.random() * 60) + "%";
        span.style.top = (10 + Math.random() * 20) + "%";
        card.appendChild(span);
        setTimeout(() => span.remove(), 800);
      }
    }

    // ===== KEY CLICK SOUND =====
    let audioCtx = null;
    function playKeySound() {
      try {
        const AC = window.AudioContext || window.webkitAudioContext;
        if (!AC) return;
        if (!audioCtx) audioCtx = new AC();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = "sine";
        osc.frequency.value = 650;
        gain.gain.value = 0.18;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        const now = audioCtx.currentTime;
        osc.start(now);
        osc.stop(now + 0.08);
      } catch (e) {}
    }
    document.addEventListener("keydown", (e) => {
      if (e.target && e.target.classList && e.target.classList.contains("answer-input")) {
        const key = e.key;
        if (key >= "0" && key <= "9") playKeySound();
      }
    });

    // ===== CHECK & CLEAR =====
    function checkAnswers() {
      if (currentSetIndex === null || currentPageIndex === null) return;

      const cards = questionGrid.querySelectorAll(".question-card");
      let correctCount = 0;

      cards.forEach(card => {
        const inputs = card.querySelectorAll(".answer-input");
        let ok = true;
        inputs.forEach(inp => {
          const correct = Number(inp.dataset.correct);
          const valStr = inp.value.trim();
          const val = valStr === "" ? 0 : Number(valStr);
          if (val !== correct) ok = false;
        });
        const icon = card.querySelector(".result-icon");
        if (ok) {
          icon.textContent = "‚úì Correct";
          icon.classList.remove("wrong");
          icon.classList.add("correct");
          launchConfettiAt(card);

          const carry1Inputs = card.querySelectorAll('.carry-input[data-layer="carry1"]');
          carry1Inputs.forEach(ci => ci.classList.add("crossed"));

          correctCount++;
        } else {
          icon.textContent = "‚úó Try again";
          icon.classList.remove("correct");
          icon.classList.add("wrong");
        }
      });

      scoreRow.textContent = "Score: " + correctCount + " / 4";
      if (correctCount === 4) {
        messageBox.textContent = "Perfect! 4/4 on this page üéâ";
        messageBox.className = "message success";
      } else if (correctCount >= 2) {
        messageBox.textContent = "Good! Fix the red ‚úó and try again üòä";
        messageBox.className = "message success";
      } else {
        messageBox.textContent = "Keep practicing. You can do it üí™";
        messageBox.className = "message error";
      }

      setPageScore(currentSetIndex, currentPageIndex, correctCount);

      renderPageScoreRow(gameScoreRow, currentSetIndex, currentPageIndex);
      renderPageScoreRow(detailScoreRow, currentSetIndex, null);
      buildPageGrid(currentSetIndex);
      buildSetOverview();

      const totalScore = getSetTotalScore(currentSetIndex);
      const completedPages = getCompletedPagesCount(currentSetIndex);
      const setNo = currentSetIndex + 1;
      if (completedPages === PAGES_PER_SET &&
          totalScore === PAGES_PER_SET * QUESTIONS_PER_PAGE) {
        setMessageBox.textContent =
          "Success! Full score on all 5 pages in Set " + setNo + " üéâ";
      } else if (completedPages > 0) {
        setMessageBox.textContent =
          "Full score on " + completedPages +
          " / " + PAGES_PER_SET + " pages. Keep going ‚ú®";
      } else {
        setMessageBox.textContent =
          "Set " + setNo + " not started yet. Try Page 1 first üòä";
      }
    }

    function clearPage() {
      const inputs = questionGrid.querySelectorAll(".answer-input, .carry-input");
      inputs.forEach(inp => {
        inp.value = "";
        inp.classList.remove("crossed");
      });
      const icons = questionGrid.querySelectorAll(".result-icon");
      icons.forEach(ic => {
        ic.textContent = "";
        ic.classList.remove("correct","wrong");
      });
      clearFeedbackOnly();
    }

    function clearFeedbackOnly() {
      scoreRow.textContent = "Score: ‚Äì / 4";
      messageBox.textContent = "";
      messageBox.className = "message";
    }

    function goNextPage() {
      if (currentSetIndex === null || currentPageIndex === null) return;
      const nextIndex = currentPageIndex + 1;
      if (nextIndex < PAGES_PER_SET) {
        showGamePage(currentSetIndex, nextIndex);
      } else {
        showSetDetail(currentSetIndex);
      }
    }

    // ===== EVENTS =====
    startWithNameBtn.addEventListener("click", () => {
      const name = (playerNameInput.value || "").trim();
      if (!name) {
        alert("Please enter your nickname first.");
        return;
      }
      savePlayerName(name);
      playerBar.classList.remove("hidden");
      showSetOverview();
    });

    changeNameBtn.addEventListener("click", () => {
      const current = loadPlayerName() || "";
      playerNameInput.value = current;
      showNameView();
    });

    backToOverviewBtn.addEventListener("click", showSetOverview);
    backToSetBtn.addEventListener("click", () => showSetDetail(currentSetIndex));

    checkBtn.addEventListener("click", checkAnswers);
    clearBtn.addEventListener("click", clearPage);
    nextPageBtn.addEventListener("click", goNextPage);

    // ===== INIT =====
    (function init() {
      const savedName = loadPlayerName();
      if (savedName) {
        playerNameDisplay.textContent = savedName;
        playerBar.classList.remove("hidden");
        showSetOverview();
      } else {
        showNameView();
      }
    })();
  </script>
</body>
</html>
